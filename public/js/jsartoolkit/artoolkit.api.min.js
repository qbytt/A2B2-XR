!function(){"use strict";var t=function(t,r,i){var a=t,o=r;if(this.orientation="landscape",this.listeners={},"number"!=typeof t){var n=t;i=r,a=n.videoWidth||n.width,o=n.videoHeight||n.height,this.image=n}if(this.defaultMarkerWidth=1,this.patternMarkers={},this.barcodeMarkers={},this.transform_mat=new Float32Array(16),this.canvas=document.createElement("canvas"),this.canvas.width=a,this.canvas.height=o,this.ctx=this.canvas.getContext("2d"),this.videoWidth=a,this.videoHeight=o,"string"==typeof i){var s=this;this.cameraParam=new e(i,function(){s._initialize()},function(t){console.error("ARController: Failed to load ARCameraParam",t)})}else this.cameraParam=i,this._initialize()};t.prototype.dispose=function(){for(var t in r.teardown(this.id),this)this[t]=null},t.prototype.process=function(t){this.detectMarker(t);var e,i,a=this.getMarkerNum();for(e in this.patternMarkers)(i=this.patternMarkers[e]).inPrevious=i.inCurrent,i.inCurrent=!1;for(e in this.barcodeMarkers)(i=this.barcodeMarkers[e]).inPrevious=i.inCurrent,i.inCurrent=!1;for(var o=0;o<a;o++){var n=this.getMarker(o),s=r.UNKNOWN_MARKER,h=this.trackPatternMarkerId(-1);n.idPatt>-1&&(n.id===n.idPatt||-1===n.idMatrix)?(h=this.trackPatternMarkerId(n.idPatt),s=r.PATTERN_MARKER,n.dir!==n.dirPatt&&this.setMarkerInfoDir(o,n.dirPatt)):n.idMatrix>-1&&(h=this.trackBarcodeMarkerId(n.idMatrix),s=r.BARCODE_MARKER,n.dir!==n.dirMatrix&&this.setMarkerInfoDir(o,n.dirMatrix)),s!==r.UNKNOWN_MARKER&&h.inPrevious?this.getTransMatSquareCont(o,h.markerWidth,h.matrix,h.matrix):this.getTransMatSquare(o,h.markerWidth,h.matrix),h.inCurrent=!0,this.transMatToGLMat(h.matrix,this.transform_mat),this.dispatchEvent({name:"getMarker",target:this,data:{index:o,type:s,marker:n,matrix:this.transform_mat}})}var d=this.getMultiMarkerCount();for(o=0;o<d;o++){var u=this.getMultiMarkerPatternCount(o);h=!1;r.getTransMatMultiSquareRobust(this.id,o),this.transMatToGLMat(this.marker_transform_mat,this.transform_mat);for(var c=0;c<u;c++){if((g=this.getMultiEachMarker(o,c)).visible>=0){h=!0,this.dispatchEvent({name:"getMultiMarker",target:this,data:{multiMarkerId:o,matrix:this.transform_mat}});break}}if(h)for(c=0;c<u;c++){var g=this.getMultiEachMarker(o,c);this.transMatToGLMat(this.marker_transform_mat,this.transform_mat),this.dispatchEvent({name:"getMultiMarkerSub",target:this,data:{multiMarkerId:o,markerIndex:c,marker:g,matrix:this.transform_mat}})}}this._bwpointer&&this.debugDraw()},t.prototype.trackPatternMarkerId=function(t,e){var r=this.patternMarkers[t];return r||(this.patternMarkers[t]=r={inPrevious:!1,inCurrent:!1,matrix:new Float32Array(12),markerWidth:e||this.defaultMarkerWidth}),e&&(r.markerWidth=e),r},t.prototype.trackBarcodeMarkerId=function(t,e){var r=this.barcodeMarkers[t];return r||(this.barcodeMarkers[t]=r={inPrevious:!1,inCurrent:!1,matrix:new Float32Array(12),markerWidth:e||this.defaultMarkerWidth}),e&&(r.markerWidth=e),r},t.prototype.getMultiMarkerCount=function(){return r.getMultiMarkerCount(this.id)},t.prototype.getMultiMarkerPatternCount=function(t){return r.getMultiMarkerNum(this.id,t)},t.prototype.addEventListener=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},t.prototype.removeEventListener=function(t,e){if(this.listeners[t]){var r=this.listeners[t].indexOf(e);r>-1&&this.listeners[t].splice(r,1)}},t.prototype.dispatchEvent=function(t){var e=this.listeners[t.name];if(e)for(var r=0;r<e.length;r++)e[r].call(this,t)},t.prototype.debugSetup=function(){document.body.appendChild(this.canvas),this.setDebugMode(1),this._bwpointer=this.getProcessingImage()},t.prototype.loadMarker=function(t,e,i){return r.addMarker(this.id,t,e,i)},t.prototype.loadMultiMarker=function(t,e,i){return r.addMultiMarker(this.id,t,e,i)},t.prototype.getTransMatSquare=function(t,e,i){return r.getTransMatSquare(this.id,t,e),i.set(this.marker_transform_mat),i},t.prototype.getTransMatSquareCont=function(t,e,i,a){return this.marker_transform_mat.set(i),r.getTransMatSquareCont(this.id,t,e),a.set(this.marker_transform_mat),a},t.prototype.getTransMatMultiSquare=function(t,e){return r.getTransMatMultiSquare(this.id,t),e.set(this.marker_transform_mat),e},t.prototype.getTransMatMultiSquareRobust=function(t,e){return r.getTransMatMultiSquare(this.id,t),e.set(this.marker_transform_mat),e},t.prototype.transMatToGLMat=function(t,e,r){return e[0]=t[0],e[4]=t[1],e[8]=t[2],e[12]=t[3],e[1]=t[4],e[5]=t[5],e[9]=t[6],e[13]=t[7],e[2]=t[8],e[6]=t[9],e[10]=t[10],e[14]=t[11],e[3]=0,e[7]=0,e[11]=0,e[15]=1,null!=r&&0!==r&&(e[12]*=r,e[13]*=r,e[14]*=r),e},t.prototype.detectMarker=function(t){return this._copyImageToHeap(t)?r.detectMarker(this.id):-99},t.prototype.getMarkerNum=function(){return r.getMarkerNum(this.id)},t.prototype.getMarker=function(t){if(0===r.getMarker(this.id,t))return r.markerInfo},t.prototype.setMarkerInfoVertex=function(t,e){for(var i=0;i<e.length;i++)this.marker_transform_mat[2*i+0]=e[i][0],this.marker_transform_mat[2*i+1]=e[i][1];return r.setMarkerInfoVertex(this.id,t)},t.prototype.cloneMarkerInfo=function(t){return JSON.parse(JSON.stringify(t))},t.prototype.getMultiEachMarker=function(t,e){if(0===r.getMultiEachMarker(this.id,t,e))return r.multiEachMarkerInfo},t.prototype.getTransformationMatrix=function(){return this.transform_mat},t.prototype.getCameraMatrix=function(){return this.camera_mat},t.prototype.getMarkerTransformationMatrix=function(){return this.marker_transform_mat},t.prototype.setDebugMode=function(t){return r.setDebugMode(this.id,t)},t.prototype.getDebugMode=function(){return r.getDebugMode(this.id)},t.prototype.getProcessingImage=function(){return r.getProcessingImage(this.id)},t.prototype.setLogLevel=function(t){return r.setLogLevel(t)},t.prototype.getLogLevel=function(){return r.getLogLevel()},t.prototype.setMarkerInfoDir=function(t,e){return r.setMarkerInfoDir(this.id,t,e)},t.prototype.setProjectionNearPlane=function(t){return r.setProjectionNearPlane(this.id,t)},t.prototype.getProjectionNearPlane=function(){return r.getProjectionNearPlane(this.id)},t.prototype.setProjectionFarPlane=function(t){return r.setProjectionFarPlane(this.id,t)},t.prototype.getProjectionFarPlane=function(){return r.getProjectionFarPlane(this.id)},t.prototype.setThresholdMode=function(t){return r.setThresholdMode(this.id,t)},t.prototype.getThresholdMode=function(){return r.getThresholdMode(this.id)},t.prototype.setThreshold=function(t){return r.setThreshold(this.id,t)},t.prototype.getThreshold=function(){return r.getThreshold(this.id)},t.prototype.setPatternDetectionMode=function(t){return r.setPatternDetectionMode(this.id,t)},t.prototype.getPatternDetectionMode=function(){return r.getPatternDetectionMode(this.id)},t.prototype.setMatrixCodeType=function(t){return r.setMatrixCodeType(this.id,t)},t.prototype.getMatrixCodeType=function(){return r.getMatrixCodeType(this.id)},t.prototype.setLabelingMode=function(t){return r.setLabelingMode(this.id,t)},t.prototype.getLabelingMode=function(){return r.getLabelingMode(this.id)},t.prototype.setPattRatio=function(t){return r.setPattRatio(this.id,t)},t.prototype.getPattRatio=function(){return r.getPattRatio(this.id)},t.prototype.setImageProcMode=function(t){return r.setImageProcMode(this.id,t)},t.prototype.getImageProcMode=function(){return r.getImageProcMode(this.id)},t.prototype.debugDraw=function(){var t=new Uint8ClampedArray(Module.HEAPU8.buffer,this._bwpointer,this.framesize),e=new ImageData(t,this.canvas.width,this.canvas.height);this.ctx.putImageData(e,0,0);for(var r=this.getMarkerNum(),i=0;i<r;i++)this._debugMarker(this.getMarker(i))},t.prototype._initialize=function(){this.id=r.setup(this.canvas.width,this.canvas.height,this.cameraParam.id);var t=r.frameMalloc;this.framepointer=t.framepointer,this.framesize=t.framesize,this.dataHeap=new Uint8Array(Module.HEAPU8.buffer,this.framepointer,this.framesize),this.camera_mat=new Float64Array(Module.HEAPU8.buffer,t.camera,16),this.marker_transform_mat=new Float64Array(Module.HEAPU8.buffer,t.transform,12),this.setProjectionNearPlane(.1),this.setProjectionFarPlane(1e3);var e=this;setTimeout(function(){e.onload&&e.onload(),e.dispatchEvent({name:"load",target:e})},1)},t.prototype._copyImageToHeap=function(t){if(t||(t=this.image),"IMG"===t.nodeName&&t.width>t.height||"VIDEO"===t.nodeName&&t.videoWidth>t.videoHeight)this.ctx.drawImage(t,0,0,this.canvas.width,this.canvas.height);else{this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var e=this.canvas.height/this.canvas.width,r=this.canvas.width*e,i=this.canvas.height*e,a=(this.canvas.width-i)/2;this.ctx.drawImage(t,a,0,i,r)}var o=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data;return!!this.dataHeap&&(this.dataHeap.set(o),!0)},t.prototype._debugMarker=function(t){var e,r;e=t.vertex;var i=this.ctx;i.strokeStyle="red",i.beginPath(),i.moveTo(e[0][0],e[0][1]),i.lineTo(e[1][0],e[1][1]),i.stroke(),i.beginPath(),i.moveTo(e[2][0],e[2][1]),i.lineTo(e[3][0],e[3][1]),i.stroke(),i.strokeStyle="green",i.beginPath(),i.lineTo(e[1][0],e[1][1]),i.lineTo(e[2][0],e[2][1]),i.stroke(),i.beginPath(),i.moveTo(e[3][0],e[3][1]),i.lineTo(e[0][0],e[0][1]),i.stroke(),r=t.pos,i.beginPath(),i.arc(r[0],r[1],8,0,2*Math.PI),i.fillStyle="red",i.fill()},t.getUserMedia=function(t){var e=t.facingMode||"environment",r=t.onSuccess,i=t.onError||function(t){console.error("ARController.getUserMedia",t)},a=document.createElement("video"),o=function(){0!==this.videoWidth&&r(a)},n=!1,s=["touchstart","touchend","touchmove","touchcancel","click","mousedown","mouseup","mousemove","keydown","keyup","keypress","scroll"],h=function(t){n&&(a.play(),a.paused||s.forEach(function(t){window.removeEventListener(t,h,!0)}))};s.forEach(function(t){window.addEventListener(t,h,!0)});var d=function(t){a.addEventListener("loadedmetadata",o,!1),a.src=window.URL.createObjectURL(t),n=!0,h()},u={},c={};t.width&&(c.width=t.width,"object"==typeof t.width?(t.width.max&&(u.maxWidth=t.width.max),t.width.min&&(u.minWidth=t.width.max)):u.maxWidth=t.width),t.height&&(c.height=t.height,"object"==typeof t.height?(t.height.max&&(u.maxHeight=t.height.max),t.height.min&&(u.minHeight=t.height.max)):u.maxHeight=t.height),c.facingMode=e,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var g={audio:!1,video:{mandatory:u}};return navigator.getUserMedia?navigator.getUserMedia(g,d,i):i("navigator.getUserMedia is not supported on your browser"),a},t.getUserMediaARController=function(r){var i={};for(var a in r)i[a]=r[a];var o=r.onSuccess,n=r.cameraParam;i.onSuccess=function(){new e(n,function(){var e=(r.maxARVideoSize||Math.max(s.videoWidth,s.videoHeight))/Math.max(s.videoWidth,s.videoHeight),i=e*s.videoWidth,a=e*s.videoHeight;if(s.videoWidth<s.videoHeight){var n=i;i=a,a=n}var h=new t(i,a,this);h.image=s,s.videoWidth<s.videoHeight?(h.orientation="portrait",h.videoWidth=s.videoHeight,h.videoHeight=s.videoWidth):(h.orientation="landscape",h.videoWidth=s.videoWidth,h.videoHeight=s.videoHeight),o(h,this)},function(t){console.error("ARController: Failed to load ARCameraParam",t)})};var s=this.getUserMedia(i);return s};var e=function(t,e,r){this.id=-1,this._src="",this.complete=!1,this.onload=e,this.onerror=r,t&&this.load(t)};e.prototype.load=function(t){if(""!==this._src)throw"ARCameraParam: Trying to load camera parameters twice.";if(this._src=t,t){var e=this;r.loadCamera(t,function(t){e.id=t,e.complete=!0,e.onload()},function(t){e.onerror(t)})}},Object.defineProperty(e.prototype,"src",{set:function(t){this.load(t)},get:function(){return this._src}}),e.prototype.dispose=function(){-1!==this.id&&r.deleteCamera(this.id),this.id=-1,this._src="",this.complete=!1};var r={UNKNOWN_MARKER:-1,PATTERN_MARKER:0,BARCODE_MARKER:1,loadCamera:function(t,e){var r="/camera_param_"+s++,i=function(){var t=Module._loadCamera(r);e&&e(t)};"object"==typeof t?h(r,t,i):t.indexOf("\n")>-1?function(t,e,r){for(var i=new Uint8Array(e.length),a=0;a<i.length;a++)i[a]=255&e.charCodeAt(a);h(t,i,r)}(r,t,i):d(t,r,i)},addMarker:function(t,e,r){var i="/marker_"+o++;d(e,i,function(){var e=Module._addMarker(t,i);r&&r(e)})},addMultiMarker:function(t,e,r){var i="/multi_marker_"+n++;d(e,i,function(a){var o=function(t){var e=(a=t,String.fromCharCode.apply(String,a)).split("\n"),r=[],i=0;var a;return e.forEach(function(t){if((t=t.trim())&&!t.startsWith("#"))switch(i){case 0:return+t,void(i=1);case 1:t.match(/^\d+$/)||r.push(t);case 2:case 3:case 4:return void i++;case 5:return void(i=1)}}),r}(a);function n(){var e=Module._addMultiMarker(t,i),a=Module.getMultiMarkerNum(t,e);r&&r(e,a)}if(!o.length)return n();var s=e.split("/").slice(0,-1).join("/");(function t(e,r){var i=e.pop();i?d(i[0],i[1],function(){t(e,r)}):r()})(o=o.map(function(t){return"patt.hiro"===t||"patt.kanji"===t||"patt2.hiro"===t||"patt2.kanji"===t?["http://127.0.0.1:8080/data/data/"+t,t]:[s+"/"+t,t]}),n)})}},i=["setup","teardown","setLogLevel","getLogLevel","setDebugMode","getDebugMode","getProcessingImage","setMarkerInfoDir","setMarkerInfoVertex","getTransMatSquare","getTransMatSquareCont","getTransMatMultiSquare","getTransMatMultiSquareRobust","getMultiMarkerNum","getMultiMarkerCount","detectMarker","getMarkerNum","getMarker","getMultiEachMarker","setProjectionNearPlane","getProjectionNearPlane","setProjectionFarPlane","getProjectionFarPlane","setThresholdMode","getThresholdMode","setThreshold","getThreshold","setPatternDetectionMode","getPatternDetectionMode","setMatrixCodeType","getMatrixCodeType","setLabelingMode","getLabelingMode","setPattRatio","getPattRatio","setImageProcMode","getImageProcMode"];function a(){for(var t in i.forEach(function(t){r[t]=Module[t]}),Module)t.match(/^AR/)&&(r[t]=Module[t])}var o=0;var n=0;var s=0;function h(t,e,r){FS.writeFile(t,e,{encoding:"binary"}),r(e)}function d(t,e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(t){var a=i.response,o=new Uint8Array(a);h(e,o,r)},i.send()}window.artoolkit=r,window.ARController=t,window.ARCameraParam=e,window.Module?a():window.Module={onRuntimeInitialized:function(){a()}}}();